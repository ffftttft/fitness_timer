# 健身计时器（Fitness Timer）

Fitness Timer 是一款专业级间歇训练计时器，使用 Flutter 构建。
支持自定义训练计划、多步骤训练、语音播报、实时卡路里显示，以及健康数据同步。

## 功能特性

### 核心训练功能

- **自定义训练计划**：创建、编辑、删除、排序多个训练计划
- **多步骤训练**：每个计划可包含多个步骤，每个步骤支持：
  - 自定义步骤名称
  - 组数（1-20 组）
  - 每组训练时长
  - 组内休息（同一步骤内各组之间的休息）
  - 组间休息（不同步骤之间的休息）
- **准备时间**：训练开始前的可选热身倒计时
- **完整训练流程**：准备 → 步骤一（第1组 → 组内休息 → 第2组...）→ 组间休息 → 步骤二... → 完成

### 语音播报（TTS）

- **"准备开始训练"**：训练开始时
- **"开始[步骤名]"**：新步骤开始时
- **"休息一下"**：进入休息阶段
- **"休息结束，继续[步骤名]"**：组内休息结束，继续同一步骤
- **"[步骤名]结束，休息一下"**：步骤切换时的休息
- **"训练结束，训练结果已保存，继续加油"**：训练完成时
- **倒计时（3、2、1）**：每个阶段最后 3 秒

### 实时显示

- **翻页时钟卡路里**：倒计时上方的卡路里显示，每秒翻页动画更新（公式：秒数 × 7.5 / 60）
- **进度指示**：显示当前组数进度，如"步骤一：2/3"
- **阶段颜色**：准备（黄色）、训练（橙色）、休息（蓝色）
- **圆环进度条**：当前阶段的可视化进度

### 训练历史

- **自动保存**：完成的训练自动保存到历史记录
- **手动结束可选保存**：提前结束训练时可选择是否保存
- **导出/导入**：历史记录导出为 CSV，支持从备份文件导入
- **批量操作**：多选记录进行批量导出或删除

### 安全与体验

- **未保存更改提示**：离开计划或步骤编辑器时，如有未保存更改会提示确认
- **退出确认**：训练进行中退出时需确认
- **弹窗自动暂停**：点击"结束训练"按钮后，弹窗显示期间计时器自动暂停
- **屏幕常亮**：训练期间屏幕保持常亮
- **后台通知**：应用在后台时仍会收到阶段结束通知

### 健康数据同步

- **Android**：同步至 Health Connect（训练时长 + 卡路里）
- **iOS**：同步至 HealthKit（训练 + 活动能量消耗）

### 多语言支持

- **中英双语**：完整的中英文界面
- **严格分离**：中文模式下不会出现英文，英文模式下不会出现中文（用户输入的步骤名除外）

## 使用说明

### 创建训练计划

1. 打开应用 → 点击 **"新建计划"** 按钮
2. 输入 **标题** 和可选的 **描述**
3. 设置 **准备时间**（默认 30 秒）
4. 点击 **"添加步骤"** 添加训练步骤：
   - 输入步骤名称（如"俯卧撑"）
   - 设置组数
   - 设置每组训练时长
   - 设置组内休息时间（仅组数 > 1 时显示）
   - 设置该步骤结束后的休息时间
5. 拖动右侧手柄可调整步骤顺序
6. 点击 **保存图标** 保存计划

### 开始训练

1. 在首页找到你的计划，点击 **播放按钮**
2. 计时器界面显示：
   - 当前步骤名称及组数进度（如"俯卧撑：2/3"）
   - 实时卡路里（翻页动画）
   - 大号倒计时数字
   - 圆环进度条
   - 下一步骤预览

### 控制训练

- **双击屏幕**：开始/暂停
- **长按屏幕**：重置
- **开始/暂停按钮**：切换计时状态
- **重置按钮**：从头开始
- **跳过按钮**：跳到下一阶段
- **结束训练按钮**（运行时显示）：提前结束，可选择是否保存

### 查看历史

1. 点击顶栏 **历史图标**
2. 查看所有历史训练记录：
   - 训练编号（6 位格式）
   - 计划名称
   - 日期时间
   - 时长、卡路里、完成率
3. 长按进入选择模式，可批量导出或删除

### 设置

- **语言切换**：点击语言图标切换中英文
- **导入备份**：从 CSV 文件恢复训练历史

## 项目结构

```
lib/
├── core/           # 主题、颜色、本地化、服务
├── data/           # 数据仓库、模型（Isar 数据库）
├── domain/         # 计时引擎、构建器
├── models/         # 训练配置、计划模型
├── presentation/   # 控制器（Riverpod）
├── providers/      # 状态管理
├── views/          # 页面（首页、编辑器、训练、历史）
└── widgets/        # 可复用 UI 组件
```

## 运行项目

```bash
# 安装依赖
flutter pub get

# 在设备/模拟器上运行
flutter run

# 或使用提供的脚本（Windows）
.\run_app.ps1
```

## 构建说明

如果看到 Kotlin 编译警告（关于 "different roots"），这是正常的——当 Flutter 依赖包位于不同驱动器时会出现。应用仍会成功构建和运行。

## 技术亮点

- **高精度计时**：基于 Stopwatch 的单调时钟，避免累积漂移
- **崩溃恢复**：计时状态每秒持久化，5 分钟内可恢复
- **iOS 灵动岛**：SwiftUI 布局文件位于 `docs/ios_live_activity/`
- **错误监控**：已集成 Sentry
- **无障碍支持**：语义标签和实时区域，支持屏幕阅读器
